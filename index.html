<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat App</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#e5ddd5;height:100vh}
.app{display:flex;height:100vh}

/* Sidebar */
.sidebar{width:300px;background:#f0f0f0;display:flex;flex-direction:column}
.sidebar-header{padding:15px;font-weight:bold;font-size:18px;background:#075e54;color:white}
.list{flex:1;overflow-y:auto}
.chat-item{padding:12px;border-bottom:1px solid #ddd;cursor:pointer}
.chat-item:hover{background:#e0e0e0}

/* Chat */
.chat{flex:1;display:flex;flex-direction:column}
.chat-header{padding:12px;background:#075e54;color:white;display:flex;justify-content:space-between;align-items:center}
.messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:8px}

/* Message bubbles */
.bubble{max-width:70%;padding:10px 14px;border-radius:18px;font-size:14px;word-wrap:break-word}
.sent{align-self:flex-end;background:#34b7f1;color:white;border-bottom-right-radius:4px}
.received{align-self:flex-start;background:white;color:black;border-bottom-left-radius:4px}
.time{font-size:10px;color:#eee;margin-top:4px;text-align:right}

/* Input */
.input{display:flex;gap:8px;padding:10px;background:#f0f0f0}
.input input[type=text]{flex:1;padding:10px;border-radius:20px;border:none}
.input button{padding:10px 14px;border:none;border-radius:50%;background:#075e54;color:white}
input[type=file]{display:none}

/* Login */
.login{display:flex;justify-content:center;align-items:center;height:100vh}
.login-box{background:white;padding:20px;border-radius:10px;width:280px;text-align:center}
.login-box input{width:100%;padding:10px;margin-bottom:10px}

/* Images */
.msg-img{max-width:200px;border-radius:12px;margin-bottom:4px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="login">
  <div class="login-box">
    <h3>Enter Username</h3>
    <input id="usernameInput" placeholder="Username">
    <button onclick="login()">Continue</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="app" style="display:none">
  <div class="sidebar">
    <div class="sidebar-header">Chats</div>
    <div id="chatList" class="list"></div>
    <div style="padding:10px">
      <input id="friendInput" placeholder="Add friend">
      <button onclick="addFriend()">Add</button><br><br>
      <input id="groupInput" placeholder="New group">
      <button onclick="createGroup()">Create</button><br><br>
      <button onclick="goProfile()">Edit Profile</button>
    </div>
  </div>

  <div class="chat">
    <div class="chat-header">
      <span id="chatName">Select a chat</span>
    </div>
    <div id="messages" class="messages"></div>
    <div class="input">
      <input id="msgInput" placeholder="Message">
      <label>
        ðŸ“·
        <input type="file" id="imgInput" accept="image/*">
      </label>
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </div>
</div>

<script>
// ðŸ”¥ Firebase config (PUT YOUR INFO)
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT.firebaseio.com",
  projectId: "PROJECT",
  storageBucket: "PROJECT.appspot.com"
});

const db = firebase.database();
const storage = firebase.storage();

let user = localStorage.getItem("username");
let currentChat = null;
let chatType = null;

// LOGIN
if(user){
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="flex";
  loadChats();
}

function login(){
  const u = usernameInput.value.trim();
  if(!u) return alert("Enter username");
  localStorage.setItem("username",u);
  user = u;
  db.ref("users/"+u).set(true);
  location.reload();
}

// LOAD CHATS
function loadChats(){
  chatList.innerHTML="";
  db.ref("friends/"+user).on("child_added",s=>{
    const d=document.createElement("div");
    d.className="chat-item";
    d.textContent=s.key;
    d.onclick=()=>openChat(s.key,"dm");
    chatList.appendChild(d);
  });
  db.ref("groups").on("child_added",s=>{
    if(s.val().members && s.val().members[user]){
      const d=document.createElement("div");
      d.className="chat-item";
      d.textContent=s.key+" (group)";
      d.onclick=()=>openChat(s.key,"group");
      chatList.appendChild(d);
    }
  });
}

// OPEN CHAT
function openChat(name,type){
  currentChat=name;
  chatType=type;
  chatName.textContent=name;
  messages.innerHTML="";
  const path = type==="group"
    ? "groups/"+name+"/messages"
    : "messages/"+user+"/"+name;

  db.ref(path).off();
  db.ref(path).on("child_added",s=>{
    renderMessage(s.val());
  });
}

// RENDER MESSAGE
function renderMessage(m){
  const b=document.createElement("div");
  b.className="bubble "+m.type;

  if(m.image){
    const img=document.createElement("img");
    img.src=m.image;
    img.className="msg-img";
    b.appendChild(img);
  }
  if(m.text) b.appendChild(document.createTextNode(m.text));

  const t=document.createElement("div");
  t.className="time";
  const d=new Date(m.time);
  t.textContent=d.getHours()+":"+d.getMinutes().toString().padStart(2,"0");
  b.appendChild(t);

  messages.appendChild(b);
  messages.scrollTop=messages.scrollHeight;
}

// SEND MESSAGE
function sendMessage(){
  if(!currentChat) return;
  const text=msgInput.value;
  const file=imgInput.files[0];
  msgInput.value=""; imgInput.value="";

  const send=(imgURL)=>{
    const msg={text:text||"",image:imgURL||"",time:Date.now(),type:"sent"};
    if(chatType==="group"){
      db.ref("groups/"+currentChat+"/messages").push({...msg,type:"received",sender:user});
    }else{
      db.ref("messages/"+user+"/"+currentChat).push(msg);
      db.ref("messages/"+currentChat+"/"+user).push({...msg,type:"received"});
    }
  };

  if(file){
    const ref=storage.ref("images/"+Date.now()+"_"+file.name);
    ref.put(file).then(()=>ref.getDownloadURL().then(url=>send(url)));
  } else send();
}

// FRIENDS & GROUPS
function addFriend(){
  const f=friendInput.value.trim();
  if(!f) return;
  db.ref("friends/"+user+"/"+f).set(true);
  db.ref("friends/"+f+"/"+user).set(true);
  friendInput.value="";
}

function createGroup(){
  const g=groupInput.value.trim();
  if(!g) return;
  db.ref("groups/"+g+"/members/"+user).set(true);
  groupInput.value="";
}

function goProfile(){
  location.href="profile.html";
}
</script>
</body>
</html>
